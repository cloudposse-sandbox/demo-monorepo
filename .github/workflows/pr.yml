name: GitHub Atmos Demo
run-name: A demo action for atmos workflows ðŸ‘½
on:
  pull_request:
jobs:
  demo-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository code
        uses: actions/checkout@v3
      - uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: |
            dynamodb:
              - 'components/terraform/dynamodb/**'
            s3bucket:
              - 'components/terraform/s3bucket/**'
            sqsQueue:
              - 'components/terraform/sqsQueue/**'
            devStack:
              - 'stacks/orgs/demo/plat/dev/**'
            prodStack:
              - 'stacks/orgs/demo/plat/prod/**'
            stageStack:
              - 'stacks/orgs/demo/plat/stage/**'

      - name: terraform linting tasks
        if: steps.changes.outputs.dynamodb == 'true'
        run: echo "running terraform linting task"

      - name: detect changes in components and stacks
        if: steps.changes.outputs.dynamodb == 'true'
        run: echo "atmos detected change in dynamodb component. running terraform plan for affected stacks."

      - name: plan dynamodb/demo-plat-dev-ue2
        if: steps.changes.outputs.dynamodb == 'true'
        run: |
          echo "atmos terraform plan dynamodb -s demo-plat-dev-ue2"
          echo "Plan: 1 to add, 0 to change, 0 to destroy."
          echo "storing plan for component dynamodb, stack demo-plat-dev-ue2 in artifacts repository"
      - name: plan dynamodb/demo-plat-stage-ue2
        if: steps.changes.outputs.dynamodb == 'true'
        run: |
          echo "atmos terraform plan dynamodb -s demo-plat-stage-ue2"
          echo "Plan: 1 to add, 0 to change, 0 to destroy."
          echo "storing plan for component dynamodb, stack demo-plat-stage-ue2 in artifacts repository"
      - name: plan dynamodb/demo-plat-prod-ue2
        if: steps.changes.outputs.dynamodb == 'true'
        run: |
          echo "atmos terraform plan dynamodb -s demo-plat-prod-ue2"
          echo "Plan: 1 to add, 0 to change, 0 to destroy."
          echo "storing plan for component dynamodb, stack demo-plat-prod-ue2 in artifacts repository"
